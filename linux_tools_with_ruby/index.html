<!DOCTYPE html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]--><!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]--><!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]--><!--[if gt IE 8]><!--><html class="no-js" lang="en">
<!--<![endif]-->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<title>Создание инструментов Linux с помощью Ruby – Diary of madman</title>
<meta name="description" content="Практическое руководство">
<meta name="theme-color" content="#00d900">
<meta name="keywords" content="Linux, Ruby, Tutorial">


<!-- Twitter Cards -->
<meta name="twitter:title" content="Создание инструментов Linux с помощью Ruby">
<meta name="twitter:description" content="Практическое руководство">
<meta name="twitter:site" content="@tonymadbrain">
<meta name="twitter:creator" content="@tonymadbrain">

<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://doam.ru/images/default-thumb.png">

<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="Создание инструментов Linux с помощью Ruby">
<meta property="og:description" content="Практическое руководство">
<meta property="og:url" content="http://doam.ru/linux_tools_with_ruby/">
<meta property="og:site_name" content="Diary of madman">





<link rel="canonical" href="http://doam.ru/linux_tools_with_ruby/">
<link href="http://doam.ru/feed.xml" type="application/atom+xml" rel="alternate" title="Diary of madman Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- For all browsers -->
<link rel="stylesheet" href="http://doam.ru/assets/css/main.css">

<style type="text/css">
  @media screen and (min-width: 300px) {.footer_img {height: 50px;}}
  @media screen and (min-width: 600px) {.footer_img {height: 90px;}}
  @media screen and (min-width: 900px) {.footer_img {height: 90px;}}
</style>

<meta http-equiv="cleartype" content="on">

<!-- HTML5 Shiv and Media Query Support -->
<!--[if lt IE 9]>
	<script src="http://doam.ru/assets/js/vendor/html5shiv.min.js"></script>
	<script src="http://doam.ru/assets/js/vendor/respond.min.js"></script>
<![endif]-->

<!-- Modernizr -->
<script src="http://doam.ru/assets/js/vendor/modernizr-2.7.1.custom.min.js"></script>

<link href="//fonts.googleapis.com/css?family=PT+Sans+Narrow:400,700%7CPT+Serif:400,700,400italic" rel="stylesheet" type="text/css">

<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="http://doam.ru/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="http://doam.ru/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="http://doam.ru/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="http://doam.ru/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="http://doam.ru/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://doam.ru/images/apple-touch-icon-144x144-precomposed.png">
<!-- Google Tag Manager -->
<noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-MXNSQJ" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-MXNSQJ');</script>
<!-- End Google Tag Manager -->
<!-- Yandex.Metrika counter --><script type="text/javascript">(function (d, w, c) { (w[c] = w[c] || []).push(function() { try { w.yaCounter13571732 = new Ya.Metrika({id:13571732, webvisor:true, clickmap:true, trackLinks:true, accurateTrackBounce:true}); } catch(e) { } }); var n = d.getElementsByTagName("script")[0], s = d.createElement("script"), f = function () { n.parentNode.insertBefore(s, n); }; s.type = "text/javascript"; s.async = true; s.src = (d.location.protocol == "https:" ? "https:" : "http:") + "//mc.yandex.ru/metrika/watch.js"; if (w.opera == "[object Opera]") { d.addEventListener("DOMContentLoaded", f, false); } else { f(); } })(document, window, "yandex_metrika_callbacks");</script><noscript><div><img src="//mc.yandex.ru/watch/13571732" style="position:absolute; left:-9999px;" alt=""></div></noscript>
<!-- /Yandex.Metrika counter -->

</head>

<body class="post">

<!--[if lt IE 9]><div class="browser-upgrade alert alert-info">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</div><![endif]-->

<div class="navigation-wrapper">
	<div class="site-name">
		<a href="http://doam.ru/">Diary of madman</a>
	</div>
<!-- /.site-name -->
	<div class="top-navigation">
		<nav role="navigation" id="site-nav" class="nav">
		    <ul>
		        
				    
				    <li><a href="http://doam.ru/tags/">Теги</a></li>
				
				    
				    <li><a href="http://doam.ru/cv/">Резюме</a></li>
				
		    </ul>
		</nav>
	</div>
<!-- /.top-navigation -->
</div>
<!-- /.navigation-wrapper -->



<div id="main" role="main">
  <div class="article-author-side">
    

<div itemscope itemtype="http://schema.org/Person">


	<img src="http://doam.ru/images/bio-photo.jpg" class="bio-photo" alt="Антон Рябов bio photo">


  <h3 itemprop="name">Антон Рябов</h3>
  <p>Не люблю бриться и у меня умный взгляд.</p>
  <a href="mailto:mail@doam.ru" class="author-social" target="_blank"><i class="fa fa-fw fa-envelope-square"></i>Email</a>
  <a href="http://twitter.com/tonymadbrain" class="author-social" target="_blank"><i class="fa fa-fw fa-twitter-square"></i> Twitter</a>
  
  
  
  
  
  <a href="http://github.com/tonymadbrain" class="author-social" target="_blank"><i class="fa fa-fw fa-github"></i> Github</a>
  
  
  
  
  
  
  
  
  
  
  <a href="http://doam.ru/feed.xml" class="author-social" target="_blank"><i class="fa fa-fw fa-rss-square"></i> RSS</a>
</div>

  </div>
  <article class="post">
    <div class="headline-wrap">
      
        <h1><a href="http://doam.ru/linux_tools_with_ruby/" rel="bookmark" title="Создание инструментов Linux с помощью Ruby">Создание инструментов Linux с помощью Ruby</a></h1>
      
    </div>
<!--/ .headline-wrap -->
    <div class="article-wrap">
      <section id="table-of-contents" class="toc">
  <header>
    <h3>
<i class="fa fa-book"></i> Обзор</h3>
  </header>
<div id="drawer">
<ul id="markdown-toc">
  <li><a href="#section" id="markdown-toc-section">Находим информацию о статусе</a></li>
  <li><a href="#section-1" id="markdown-toc-section-1">Список процессов</a></li>
  <li><a href="#section-2" id="markdown-toc-section-2">Кто слушает?</a></li>
  <li><a href="#section-3" id="markdown-toc-section-3">Хватит использовать мой порт!</a></li>
  <li><a href="#section-4" id="markdown-toc-section-4">Заключение</a></li>
</ul>

  </div>
</section>
<!-- /#table-of-contents -->

<p><br>
<img src="https://farm9.staticflickr.com/8788/28593393561_e400bbec7e_o.png">
<br>
<br></p>

<p>Инструменты <code>ps</code>, <code>top</code> и <code>netstat</code> крутые, они дают много полезной информации о том, что происходит в системе. Но как они работают? Где берут и как получают всю эту информацию? В этой записи мы будем воссоздавать три популярных Linux инструмента вместе, вы убиваете сразу двух зайцев, изучаете и Ruby и Linux в одно время. <img class="emoji" title=":wink:" alt=":wink:" src="https://assets-cdn.github.com/images/icons/emoji/unicode/1f609.png" height="20" width="20" align="absmiddle"></p>

<blockquote>
  <p>От переводчика: <a href="http://www.blackbytes.info/2016/06/linux-tools-with-ruby/" target="_blank">Оригинал статьи</a></p>
</blockquote>

<h3 id="section">Находим информацию о статусе</h3>

<p>Итак, давайте попробуем ответит на вопрос “где все эти инструменты берут информацию?”. Ответ “в специальной файловой системе <code>/proc</code>”. Если вы посмотрите в каталог <code>/proc</code> то найдете там кучу папок и файлов, как и в любом другом каталоге на вашем компьютере. Но фишка в том, что это не настоящие файлы, это просто путь для ядра Linux предоставить данные пользователю.
Это очень удобно, потому что мы можем обрабатывать их как обычные файлы, т.е. читать без каких-либо особых инструментов. В мире Linux много вещей работают по этому принципу, если нужны еще примеры, посмотрите в директорию <code>/dev</code>. Теперь, когда мы понимаем что к чему, давайте заглянем внутрь каталога <code>/proc</code>.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">1
10
104
105
11
11015
11469
11474
11552
11655</code></pre></figure>

<p>Это лишь часть списка для примера, чтобы вы могли понять шаблон. Что означают все эти цифры? Чтож, это так называемые PIDы (Process IDs). Каждая запись содержит информацию об определенном процессе. Если вы запустите <code>ps</code> то увидите что каждый процесс имеет ассоциированный идентификатор - PID:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">PID   TTY      TIME     CMD
<span class="m">15952</span> pts/5    00:00:00 ps
<span class="m">22698</span> pts/5    00:00:01 bash</code></pre></figure>

<p>Отсюда мы видим, что ps просто обходит все элементы <code>/proc</code> и выводит информацию, которую найдет. Давайте посмотрим что находится внутри одного из пронумерованных каталогов:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">attr
autogroup
auxv
cgroup
clear_refs
cmdline
comm
cpuset
cwd
environ
exe
fd</code></pre></figure>

<p>Это сокращенный вывод чтобы сэкономить место, однако я настоятельно рекомендую вам посмотреть полный список. Приведем некоторые важные/интересные записи:</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">Запись</th>
      <th style="text-align: left">Описание</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">comm</td>
      <td style="text-align: left">имя программы</td>
    </tr>
    <tr>
      <td style="text-align: left">cmdline</td>
      <td style="text-align: left">команда, использованная для запуска этого процесса</td>
    </tr>
    <tr>
      <td style="text-align: left">environ</td>
      <td style="text-align: left">Environment переменные с которыми был запущен процесс</td>
    </tr>
    <tr>
      <td style="text-align: left">status</td>
      <td style="text-align: left">Статус процесса (running, sleeping…) и использование памяти</td>
    </tr>
    <tr>
      <td style="text-align: left">fd</td>
      <td style="text-align: left">Каталог содержащий дескрипторы файлов (open files, sockets…)</td>
    </tr>
  </tbody>
</table>

<p>Теперь, когда мы узнали это, можем начинать писать некоторые инструменты!</p>

<h3 id="section-1">Список процессов</h3>

<p>Давайте начнем с получения списка всех директорий в каталоге <code>/proc</code>. Мы можем сделать это используя Ruby класс <code>Dir</code>.
<br>
<br>
Пример:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="no">Dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">"/proc/[0-9]*"</span><span class="p">)</span></code></pre></figure>

<blockquote>
  <p>Обратите внимание как я использовал диапазон цифр, это нужно так как в каталоге <code>/proc</code> находится много других папок, которые сейчас нас не интересуют.</p>
</blockquote>

<p>Теперь можем пройтись (проитерировать) по этому списку и вывести две колонки, в первой PID, во второй имя программы.
<br>
<br>
Пример:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">pids</span> <span class="o">=</span> <span class="no">Dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">"/proc/[0-9]*"</span><span class="p">)</span>

<span class="nb">puts</span> <span class="s2">"PID</span><span class="se">\t</span><span class="s2">CMD"</span>
<span class="nb">puts</span> <span class="s2">"-"</span> <span class="o">*</span> <span class="mi">15</span>

<span class="n">pids</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">pid</span><span class="o">|</span>
  <span class="n">cmd</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">pid</span> <span class="o">+</span> <span class="s2">"/comm"</span><span class="p">)</span>
  <span class="n">pid</span> <span class="o">=</span> <span class="n">pid</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="sr">/\d+/</span><span class="p">)</span><span class="o">.</span><span class="n">first</span>

  <span class="nb">puts</span> <span class="s2">"</span><span class="si">#{</span><span class="n">pid</span><span class="si">}</span><span class="se">\t</span><span class="si">#{</span><span class="n">cmd</span><span class="si">}</span><span class="s2">"</span>
<span class="k">end</span></code></pre></figure>

<p>И примерно вот таким должен быть вывод:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">PID    CMD
---------------
<span class="m">1</span>     systemd
<span class="m">2</span>     kthreadd
<span class="m">3</span>     ksoftirqd/0
<span class="m">5</span>     kworker/0
<span class="m">7</span>     migration/0
<span class="m">8</span>     rcu_preempt
<span class="m">9</span>     rcu_bh
<span class="m">10</span>    rcu_sched</code></pre></figure>

<p>Хей, выглядит так, будто мы только что сделали <code>ps</code>! Да, наша программа не поддерживает все фишки оригинала, но мы сделали кое-что работающее.</p>

<h3 id="section-2">Кто слушает?</h3>

<p>Давайте теперь попробуем воспроизвести <code>netstat</code>, вот так выглядит вывод этой утилиты (с флагами -ant).</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">Active Internet connections <span class="o">(</span>servers and established<span class="o">)</span>

Proto Recv-Q Send-Q Local Address           Foreign Address         State
tcp        <span class="m">0</span>      <span class="m">0</span> 127.0.0.1:5432          0.0.0.0:*               LISTEN
tcp        <span class="m">0</span>      <span class="m">0</span> 192.168.1.82:39530      182.14.172.159:22       ESTABLISHED</code></pre></figure>

<p>Где же мы можем найти эту информацию? Если вы сказали “внутри <code>/proc</code>” вы правы! Точнее она лежит в каталоге <code>/proc/net/tcp</code>. Но есть маленькая проблемка, данные лежащие там не совсем похожи на вывод <code>netstat</code>!</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">0: 0100007F:1538 00000000:0000 0A 00000000:00000000 00:00000000 <span class="m">00000000</span>  <span class="m">1001</span> <span class="m">0</span> 9216
1: 2E58A8C0:9A6A 9FBB0EB9:0016 <span class="m">01</span> 00000000:00000000 00:00000000 <span class="m">00000000</span>  <span class="m">1000</span> <span class="m">0</span> 258603</code></pre></figure>

<p>Это значит что нам придется их распарсить с помощью регулярных выражений. На данный момент давайте займемся только локальным адресом и статусом.
<br>
<br>
Вот регулярное выражение, которое я подобрал для этой задачи:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="se">\s</span>+<span class="se">\d</span>+: <span class="o">(</span>?&lt;local_addr&gt;<span class="se">\w</span>+<span class="o">)</span>:<span class="o">(</span>?&lt;local_port&gt;<span class="se">\w</span>+<span class="o">)</span> <span class="se">\w</span>+:<span class="se">\w</span>+ <span class="o">(</span>?&lt;status&gt;<span class="se">\w</span>+<span class="o">)</span></code></pre></figure>

<p>Оно позволит нам получить шестнадцатеричные значения, которые еще нужно конвертировать в десятичные. Давайте создадим класс, который будет этим заниматься.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">TCPInfo</span>
  <span class="no">LINE_REGEX</span> <span class="o">=</span> <span class="sr">/\s+\d+: (?&lt;local_addr&gt;\w+):(?&lt;local_port&gt;\w+) \w+:\w+ (?&lt;status&gt;\w+)/</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="vi">@data</span> <span class="o">=</span> <span class="n">parse</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="n">line</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="no">LINE_REGEX</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">local_port</span>
    <span class="vi">@data</span><span class="o">[</span><span class="s2">"local_port"</span><span class="o">].</span><span class="n">to_i</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="c1"># Convert hex to regular IP notation</span>
  <span class="k">def</span> <span class="nf">local_addr</span>
    <span class="n">decimal_to_ip</span><span class="p">(</span><span class="vi">@data</span><span class="o">[</span><span class="s2">"local_addr"</span><span class="o">].</span><span class="n">to_i</span><span class="p">(</span><span class="mi">16</span><span class="p">))</span>
  <span class="k">end</span>

  <span class="no">STATUSES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">"0A"</span> <span class="o">=&gt;</span> <span class="s2">"LISTENING"</span><span class="p">,</span>
    <span class="s2">"01"</span> <span class="o">=&gt;</span> <span class="s2">"ESTABLISHED"</span><span class="p">,</span>
    <span class="s2">"06"</span> <span class="o">=&gt;</span> <span class="s2">"TIME_WAIT"</span><span class="p">,</span>
    <span class="s2">"08"</span> <span class="o">=&gt;</span> <span class="s2">"CLOSE_WAIT"</span>
  <span class="p">}</span>

  <span class="k">def</span> <span class="nf">status</span>
    <span class="n">code</span> <span class="o">=</span> <span class="vi">@data</span><span class="o">[</span><span class="s2">"status"</span><span class="o">]</span>

    <span class="no">STATUSES</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="s2">"UNKNOWN"</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="c1"># Don't worry too much about this :)</span>
  <span class="k">def</span> <span class="nf">decimal_to_ip</span><span class="p">(</span><span class="n">decimal</span><span class="p">)</span>
    <span class="n">ip</span> <span class="o">=</span> <span class="o">[]</span>

    <span class="n">ip</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">decimal</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span>
    <span class="n">ip</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">decimal</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span>
    <span class="n">ip</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">decimal</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span>
    <span class="n">ip</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">decimal</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span>

    <span class="n">ip</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">"."</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<p>Единственная вещь, которую осталось сделать это вывести результаты в виде таблицы.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="nb">require</span> <span class="s1">'table_print'</span>

<span class="n">tp</span> <span class="n">connections</span></code></pre></figure>

<p>Пример вывода:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">STATUS      <span class="p">|</span> LOCAL_PORT <span class="p">|</span> LOCAL_ADDR
------------<span class="p">|</span>------------<span class="p">|</span>--------------
LISTENING   <span class="p">|</span> <span class="m">5432</span>       <span class="p">|</span> 127.0.0.1
ESTABLISHED <span class="p">|</span> <span class="m">39530</span>      <span class="p">|</span> 192.168.88.46</code></pre></figure>

<p>Да, этот gem крутой!
<br>
<br>
Я только недавно нашел его и выглядит так будто теперь не придется играться с <code>ljust</code> / <code>rjust</code> :)</p>

<h3 id="section-3">Хватит использовать мой порт!</h3>

<p>Вы когда-нибудь видели подобное сообщение?</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">Address already in use - <span class="nb">bind</span><span class="o">(</span>2<span class="o">)</span> <span class="k">for</span> <span class="s2">"localhost"</span> port 5000</code></pre></figure>

<p>Хммм… интересно, что же использует этот порт …</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">fuser -n tcp -v 5000

PORT       USER        PID   ACCESS CMD
5000/tcp:  blackbytes  <span class="m">30893</span> F....  nc</code></pre></figure>

<p>Ага, вот наш виновник! Теперь мы можем остановить эту программу если не хотим чтобы она была запущена и это освободит наш порт. Как программа <code>fuser</code> нашла кто использует запрашиваемый порт? Именно! Это снова файловая система <code>/proc</code>. По сути, она объединяет две вещи, которые мы уже изучили ранее: обход списка процессов и чтение активных подключений из <code>/proc/net/tcp</code>. Нам нужен только один дополнительный шаг: найти способ ассоциировать информацию по открытым портам с PID. Если посмотреть данные о TCP, которые мы можем получить из <code>/proc/net/tcp</code>, то PID там нет. Но мы можем использовать номер inode (иноды).</p>

<blockquote>
  <p>“Индексный дескриптор — это структура данных в традиционных для ОС UNIX файловых системах (ФС). В этой структуре хранится метаинформация о стандартных файлах, каталогах или других объектах файловой системы, кроме непосредственно данных и имени.” – Википедия</p>
</blockquote>

<p>Как мы можем использовать иноду для поиска совпадающего процесса? Если мы посмотрим в каталог <code>fd</code> процесса, который, как мы знаем имеет открытый порт, то найдем строку, наподобие этой:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">/proc/3295/fd/5 -&gt; socket:<span class="o">[</span>12345<span class="o">]</span></code></pre></figure>

<p>Число между квадратными скобками это номер иноды. Теперь, все что нам нужно, это проитерировать все файлы и мы найдем совпадающий процесс.
<br>
<br>
Вот один из способов сделать это:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">x</span> <span class="o">=</span>
<span class="no">Dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">"/proc/[0-9]*/fd/*"</span><span class="p">)</span><span class="o">.</span><span class="n">find</span> <span class="k">do</span> <span class="o">|</span><span class="n">fd</span><span class="o">|</span>
  <span class="no">File</span><span class="o">.</span><span class="n">readlink</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span><span class="o">.</span><span class="n">include?</span> <span class="s2">"socket:[</span><span class="si">#{</span><span class="n">socket_inode</span><span class="si">}</span><span class="s2">]"</span> <span class="k">rescue</span> <span class="kp">nil</span>
<span class="k">end</span>

<span class="n">pid</span>  <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="sr">/\d+/</span><span class="p">)</span><span class="o">.</span><span class="n">first</span>
<span class="nb">name</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">readlink</span><span class="p">(</span><span class="s2">"/proc/</span><span class="si">#{</span><span class="n">pid</span><span class="si">}</span><span class="s2">/exe"</span><span class="p">)</span>

<span class="nb">puts</span> <span class="s2">"Port </span><span class="si">#{</span><span class="n">hex_port</span><span class="o">.</span><span class="n">to_i</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span><span class="si">}</span><span class="s2"> in use by </span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2"> (</span><span class="si">#{</span><span class="n">pid</span><span class="si">}</span><span class="s2">)"</span></code></pre></figure>

<p>Пример вывода:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">Port <span class="m">5432</span> in use by /usr/bin/postgres <span class="o">(</span>474<span class="o">)</span></code></pre></figure>

<p>Помните, что запускать код, приведенный выше нужно от суперпользователя (root) или от пользователя - владельца процесса. В обратном случае вы не сможете читать информацию о процессе из <code>/proc</code>.</p>

<h3 id="section-4">Заключение</h3>

<p>В этой заметке вы узнали, что Linux предоставляет много данных с помощью виртуальной файловой системы <code>/proc</code>. Также вы научились воссоздавать популярные Linux утилиты такие как <code>ps</code>, <code>netstat</code> и <code>fuser</code> с использованием данных, полученных из <code>/proc</code>.</p>


      
        <a href="/tag/linux">#Linux</a>
      
        <a href="/tag/ruby">#Ruby</a>
      
        <a href="/tag/tutorial">#Tutorial</a>
      
        <!-- <a href="/tag/linux/" rel="tag">Linux</a>, <a href="/tag/ruby/" rel="tag">Ruby</a>, <a href="/tag/tutorial/" rel="tag">Tutorial</a> -->
      <hr>
      <footer role="contentinfo">
        <div style="text-align: center;" class="social-share">
  <h4>Поделиться</h4>
  <ul>
    <li>
      <a href="https://twitter.com/intent/tweet?text=%D0%A1%D0%BE%D0%B7%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5%20%D0%B8%D0%BD%D1%81%D1%82%D1%80%D1%83%D0%BC%D0%B5%D0%BD%D1%82%D0%BE%D0%B2%20Linux%20%D1%81%20%D0%BF%D0%BE%D0%BC%D0%BE%D1%89%D1%8C%D1%8E%20Ruby%20%23doamru%20http://doam.ru/linux_tools_with_ruby/" target="_blank" class="twitter" title="Share on Twitter"><i class="fa fa-twitter"></i><span> Twitter</span></a>
    </li>
    <li>
      <a href="http://vk.com/share.php?url=http://doam.ru/linux_tools_with_ruby/" class="vk" title="Share on VK" target="_blank"><i class="fa fa-vk"></i><span>ВКонтакте</span></a>
    </li>
    <li>
      <a href="https://www.facebook.com/sharer/sharer.php?u=http://doam.ru/linux_tools_with_ruby/" target="_blank" class="facebook" title="Share on Facebook"><i class="fa fa-facebook"></i><span> Facebook</span></a>
    </li>
    <li>
      <a href="https://plus.google.com/share?url=http://doam.ru/linux_tools_with_ruby/" target="_blank" class="google-plus" title="Share on Google Plus"><i class="fa fa-google-plus"></i><span> Google+</span></a>
    </li>
  </ul>
</div>
<!-- /.social-share -->

        <p class="byline"><strong>Создание инструментов Linux с помощью Ruby</strong> опубликовано <time datetime="2016-07-26T00:09:58+03:00">26 July, 2016</time>.</p>
      </footer>
    </div>
<!-- /.article-wrap -->
  
  </article>
</div>
<!-- /#main -->

<div class="footer-wrap">
  <div class="related-articles">
  <h4>Вас могут заинтересовать <small class="pull-right">(<a href="http://doam.ru">Смотреть все записи</a>)</small>
</h4>
    <ul>
    
      <li><a href="http://doam.ru/rails-webpack-heroku/" title="Деплоим Rails + Webpack приложение на Heroku">Деплоим Rails + Webpack приложение на Heroku</a></li>
    
      <li><a href="http://doam.ru/adding_static_pages_to_your_rails_app/" title="Добавление статических страниц в Rails приложение">Добавление статических страниц в Rails приложение</a></li>
    
      <li><a href="http://doam.ru/https_in_nginx_using_letsencrypt/" title="HTTPS в Nginx с сертификатом от Let's Encrypt">HTTPS в Nginx с сертификатом от Let's Encrypt</a></li>
    
    </ul>
    <hr>
  </div>
<!-- /.related-articles -->
  <footer>
    

<div style="text-align: center;"><span>© 2011 - 2016 Diary of madman.</span></div>
<br>
<div style="text-align: center;"><span><a href="http://doam.ru/license/" target="_blank"><img src="http://doam.ru/license.png"></a></span></div>

  </footer>
</div>
<!-- /.footer-wrap -->

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="http://doam.ru/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="http://doam.ru/assets/js/scripts.min.js"></script>



</body>
</html>
