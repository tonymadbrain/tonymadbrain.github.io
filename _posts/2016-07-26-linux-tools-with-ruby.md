---
layout: post
title: Создание инструментов Linux с помощью Ruby
excerpt: "Практическое руководство"
permalink: /linux-tools-with-ruby/
tags:
  - Linux
  - Ruby
date: 2016-07-26T00:09:58+03:00
---

{% include _toc.html %}

Инструменты `ps`, `top` и `netstat` крутые, они дают много полезной информации о том, что происходит в системе. Но как они работают? Где берут и как получают всю эту информацию? В этой записи мы будем воссоздавать три популярных Linux инструмента вместе, вы убиваете сразу двух зайцев, изучаете и Ruby и Linux в одно время. :wink:

> От переводчика: <a href="http://www.blackbytes.info/2016/06/linux-tools-with-ruby/" target="_blank">Оригинал статьи</a>

### Находим информацию о статусе

Итак, давайте попробуем ответит на вопрос "где все эти инструменты берут информацию?". Ответ "в специальной файловой системе `/proc`". Если вы посмотрите в каталог `/proc` то найдете там кучу папок и файлов, как и в любом другом каталоге на вашем компьютере. Но фишка в том, что это не настоящие файлы, это просто путь для ядра Linux предоставить данные пользователю.
Это очень удобно, потому что мы можем обрабатывать их как обычные файлы, т.е. читать без каких-либо особых инструментов. В мире Linux много вещей работают по этому принципу, если нужны еще примеры, посмотрите в директорию `/dev`. Теперь, когда мы понимаем что к чему, давайте заглянем внутрь каталога `/proc`.

{% highlight bash %}
1
10
104
105
11
11015
11469
11474
11552
11655
{% endhighlight %}

Это лишь часть списка для примера, чтобы вы могли понять шаблон. Что означают все эти цифры? Чтож, это так называемые PIDы (Process IDs). Каждая запись содержит информацию об определенном процессее. Если вы запустите `ps` то увидлите что каждый процесс имееет ассоциированный идентификатор - PID:

{% highlight bash %}
PID   TTY      TIME     CMD
15952 pts/5    00:00:00 ps
22698 pts/5    00:00:01 bash
{% endhighlight %}

Отсюда мы видим, что ps просто обходит все элементы `/proc` и выводит информацию, которую найдет. Давайте посмотрим что находится внутри одного из пронумерованных каталогов:

{% highlight bash %}
attr
autogroup
auxv
cgroup
clear_refs
cmdline
comm
cpuset
cwd
environ
exe
fd
{% endhighlight %}

Это сокращенный вывод чтобы сэкономить место, однако я настоятельно рекомендую вам посмотреть полный список. Приведем некоторые важные/интересные записи:

| Запись  | Описание |
|:------|:--------|
| comm   | имя программы    |
| cmdline   | команда, использованная для запуска этого процесса    |
| environ   | Environment переменные с которыми был запущен процесс    |
| status   | Статус процесса (running, sleeping…) и использование памяти    |
| fd   | Каталог содержащий дескрипторы файлов (open files, sockets…)    |

Теперь, когда мы узнали это, можем начинать писать некоторые инструменты!

### Список процессов

Давайте начнем с получения списка всех директорий в каталоге `/proc`. Мы можем сделать это используя Ruby класс `Dir`.
<br>
<br>
Пример:

{% highlight ruby %}
Dir.glob("/proc/[0-9]*")
{% endhighlight %}

> Обратите внимание как я использовал диапазон цифр, это нужно так как в каталоге `/proc` находится много других папок, которые сейчас нас не интересуют.

Теперь можем пройтись (проитерировать) по этому списку и вывести две колонки, в первой PID, во второй имя программы.
<br>
<br>
Пример:

{% highlight ruby %}
pids = Dir.glob("/proc/[0-9]*")

puts "PID\tCMD"
puts "-" * 15

pids.each do |pid|
  cmd = File.read(pid + "/comm")
  pid = pid.scan(/\d+/).first

  puts "#{pid}\t#{cmd}"
end
{% endhighlight %}

И примерно вот таким должен быть вывод:

{% highlight bash %}
PID    CMD
---------------
1     systemd
2     kthreadd
3     ksoftirqd/0
5     kworker/0
7     migration/0
8     rcu_preempt
9     rcu_bh
10    rcu_sched
{% endhighlight %}

Хей, выглядит так, буд-то мы только что сделали `ps`! Да, наша программа не поддерживает все фишки оригинала, но мы сделали кое-что работающее.

### Who Is Listening?
