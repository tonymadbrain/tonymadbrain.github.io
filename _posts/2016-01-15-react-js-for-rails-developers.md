---
layout: post
title: React.js - tutorial для Rails разработчиков
tags:
  - Ruby
  - Ruby on Rails
  - React
  - Tutorial
date: 2016-01-15T08:53:14+03:00
---

React.js это новый популярный игрок из команды "Фреймворки JavaScript", и он отличается своей простотой. Там где другие фреймворки реализуют полноценный MVC, можно сказать что React реализует только V (причем многие заменяют V в своих фреймворках на React). Приложения на React строятся на двух основных принципах: *Компоненты* (Components) и *Состояния* (States). Компоненты могут быть сделаны из других компонентов поменьше, встроенных или кастомных; Состояния это, как называют его ребята из Facebook - *one-way reactive data flow*, означает что наш UI будет реагировать на каждое изменение состояния.

Одна из хороших вещей в React это то, что он не требует дополнительных зависимостей, что делает его подключаемым с практически любой JS библиотекой. Воспользовавшись этой функцией, мы собираемся включить его в наш Rails стек и построить *frontend-powered* приложение, или, если пожелаете, Rails вьюхи на стероидах.

здесь будет картинка поста

###Макет приложения

В данной статье, мы будем создавать с нуля маленькое приложение для отслеживания затрат; каждая запись будет содержать дату, заголовок и сумму. Записи будут делиться на Кредит (Credit) если сумма больше нуля и Дебет (Debit) в обратном случае. Вот макет проекта:

<br>
<img src="https://farm2.staticflickr.com/1659/23794397494_c45a9b62a6_o.png">
<br>

Суммируя, в приложении будут следующие кейсы:

* Когда пользователь создает новую запись через горизонтальную форму, она (запись) будет добавляться в таблицу со всеми записями
* Пользователь сможет построчно редактировать любую запись
* Клик по любой кнопке *Delete* будет удалять связанную запись из таблицы
* Добавление, редактирование и удаление записей будет обновлять сумму в окне на верху страницы

###Создаем приложение

Любое приложение начинается с простых вещей. Создадим наше приложение и назовем его, например, `Accounts`:

{% highlight bash %}
rails new accounts
{% endhighlight %}

> Я рекомендую использовать RVM для управления версиями Ruby и для каждого приложения отдельный gemset, подробнее можно посмотреть в <a href="http://doam.ru/sozdaniye-novogo-prilozheniya-na-rails/" target="_blank">этой статье</a>.

Для UI нашего проекта будет использован Twitter Bootstrap. Процесс установки bootstrap немного выходит из рамок данного how-to, вы можете установить например официальный гем `bootstrap-sass` следуя <a href="https://github.com/twbs/bootstrap-sass" target="_blank">инструкции</a> или использовать <a href="https://rails-assets.org/" target="_blank">rails-assets</a>.

Когда наш проект инициализирован, нужно добавить в него React. В данной записи мы будем устанавливать официальный гем <a href="https://github.com/reactjs/react-rails" target="_blank">react-rails</a> потому что будем использовать некоторые крутые фишки, реализованные в данном геме, но есть и другие способы выполнить эту задачу, например все теже <a href="https://rails-assets.org/" target="_blank">rails-assets</a> или можно скачать исходники с <a href="https://facebook.github.io/react/" target="_blank">официальной страницы</a> и разместить их в паке `javascrips`.

Если вы до этого имели дело с Rails, то вы знаете как легко добавить гем в проект, добавим нужный нам гем `react-rails` в *Gemfile*:

{% highlight ruby %}
gem 'react-rails', '~> 1.0'
{% endhighlight %}

Затем, естественно, устанавливаем новые гемы:


{% highlight bash %}
bundle install
{% endhighlight %}

`react-rails` идет с установочным скриптом, который создаст файл `component.js` и каталог `components` в папке `app/assets/javascripts` где собственно и будут жить наши компоненты React.

{% highlight bash %}
rails g react:install
{% endhighlight %}

Если после процесса установки вы загляните в файл `application.js` то найдете там три новых линии:

{% highlight javascript %}
  //= require react
  //= require react_ujs
  //= require components
{% endhighlight %}

В основном, он включает актуальную react библиотеку, манифест `components` и `ujs`. Как вы могли догадаться для имен файлов react-rails включает ненавязчивый JavaScript драйвер, который поможет нам монтировать React компоненты и будет поддерживать события *Turbolinks*.

###Создаем ресурс

Мы создадим ресурс `Record`, который будет включать поля `date`, `title` и `amount`. Вместо использования генератора `scaffold`, мы будем использовать генератор `resource`, потому что нам не понадобятся все файлы и методы, которые создаются при исползовании `scaffold`.

{% highlight bash %}
rails g resource Record title date:date amount:float
{% endhighlight %}

Чуть чуть магии и у нас будет готовый ресурс `Record`, включающий модель, контроллер и машруты. Остается только создать базу данных и запустить миграции.

{% highlight bash %}
rake db:create db:migrate
{% endhighlight %}

Дополнительно вы можете создать несколько записей в базе данных используя `rails console`:

{% highlight bash %}
Record.create title: 'Record 1', date: Date.today, amount: 500
Record.create title: 'Record 2', date: Date.today, amount: -100
{% endhighlight %}

Не забудьте запустить сервер с помощью команды `rails s`.
<br>
Ура! Теперь мы можем кодить.

###Вложенные компоненты: список записей

Нашей первой задачей будет рендерить любые записи в таблице. Для начала, нужно создать экшен `index` в нашем контроллере `Records`:

{% highlight ruby %}
# app/controllers/records_controller.rb

class RecordsController < ApplicationController
  def index
    @records = Record.all
  end
end
{% endhighlight %}

Далее, нам нужно создать новый файл `index.html.erb` в папке `app/views/records/`, этот файл будет мостом между нашим Rails приложением и React компонентами. Чтобы достигнуть этого мы будем использовать хелпер метод `react_component`, который получает имя компонента React, который мы хотим отрендерить вместе с данными которые мы хотим в него передать.

{% highlight ruby %}
<%# app/views/records/index.html.erb %>

  <%= react_component 'Records', { data: @records } %>
{% endhighlight %}

Стоит отметить, что этот хелпер предоставляется гемом `react-rails` и если использовать другие способы интеграции React в Rails приложение, то он не будет работать.

Теперь вы можете открыть http://localhost:3000/records в браузере. Очевидно, что сейчас ничего работать не будет, потому что у нас просто напросто нет React компонента Records, но если мы посмотрим в код сгенерированной страницы, то увидим примерно следующее:

{% highlight html %}
<div data-react-class="Records" data-react-props="{...}">
  </div>
{% endhighlight %}

C такой разметкой, `react_ujs` видит что мы пытаемся рендерить React компонент и будет инициализировать его, включая свойства, которые мы передали через `react_component`, в нашем случае содержимое `@records`.

Пришло время сделать наш первый React компонент. В каталоге `javascripts/components` создаем новый файл и называем его `records.js.coffee`, этот файл и будет содержать наш компонент Records.

{% highlight coffeescript %}
# app/assets/javascripts/components/records.js.coffee

@Records = React.createClass
  render: ->
    React.DOM.div
      className: 'records'
      React.DOM.h2
        className: 'title'
        'Records'
{% endhighlight %}

Каждый компонент должен содержать метод `render`, который будет отвечать за рендеринг самого себя. Этот метод должен возвращать экземпляр класса ReactComponent, в этом случае, когда React выполнит ре-рендер, он (экземпляр) будет обработан оптимальным путем (React обнаруживает существование новых узлов путем создания виртуального DOM в памяти). В примере выше мы создали экзмепляр h2, встроенный ReactComponent.

> Другой способ инициализировать ReactComponents внутри метода render через `JSX` синтаксис. Пример кода выше эквивалентент следующему:

{% highlight coffeescript %}
render: ->
    `<div className="records">
      <h2 className="title"> Records </h2>
    </div>`
{% endhighlight %}

Я рекомендую, если вы работаете с soffescript, использовать синтаксис `React.DOM` вместо `JSX`, потому что код будет выстраиваться иерархично, как, например, в haml. Однако, если вы интегрируете React в существующее приложение с erb, вы можете реюзать уже существующий код конвертируя его в *JSX*.

Теперь обновим страницу в браузере.

Отлично! Мы отрендерили наш первый компонент React. Теперь настало время для отображения наших записей (records).




