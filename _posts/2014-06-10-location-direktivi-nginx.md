---
layout: post
title: Location директивы Nginx
date: '2014-06-10 12:01:37'
excerpt: ""
---

Директива Location широко используется в конфигурациях Nginx, поэтому во избежание проблем веб-сайта, сначала нужно понять, как она работает.

<h4>Синтаксис директивы location в Nginx</h4>

<pre>Синтаксис: location [ = | ~ | ~* | ^~ ] uri { ... }
location { } @ name { ... }
Контекст: server / location</pre>

Во-первых, важно знать, что в зависимости от URI, который вы обрабатываете, могут быть применены различные конфигурации, вы можете использовать символьные строки, а также регулярные выражения, как вам угодно.
<p></p>
<h4>Директива Location с регулярными выражениями</h4>

Для того чтобы использовать регулярные выражения, необходимо всегда использовать префикс:

<pre>"~" должен использоваться для соответствия с учетом регистра
"~*" должен использоваться для соответствия без учета регистра</pre>

Если точное совпадение с регулярным выражением не нужно, тогда указывается регулярное выражение, назначенное пустому блоку, а остальная часть запросов может быть сопоставлена с использованием местоположения /.

Заметка: Nginx имеет возможность декодировать URI, в реальном времени. Например, для того, чтобы найти соответствия “/app/%20/images” вы можете использовать “/app/ /images” для определения местоположения.
<p></p>
<h4>Location и символьные строки</h4>

Префикс "=" означает точное соответствие между URIзапросом и параметром местонахождения. Когда это происходит, поиск сразу же прекращается. Если вы видите, что ваше приложение часто обращается с запросом "/", лучше использовать символьную строку, например, "location = /", это ускорит обработку этого запроса.
<p></p>
<h4>Примеры директивы Location</h4>

<pre>location  = / {
# если совпадает точно с запросом /.

# пример #1
}
</pre>
<pre>location  / {
# совпадает с любым запросом, начинающимся с /, однако, регулярные выражения будут
# сопоставлены в первую очередь.

# пример #2
}</pre>
<pre>location /data/ {
# данная конфигурация сопоставляется с любым запросом, начинающимся с  /data/ и затем,
# поиск продолжается,
# в этом примере будут проверены регулярные выражения и если соответствия не будут найдены, запрос будет соответствовать /data/

# пример #3
}
</pre>
<pre>location ^~ /img/ {
# совпадает с любым запросом, начинающимся с  /img/ и затем поиск прекращается,
# в этом примере нет регулярных выражений.

# пример #4
}
</pre>
<pre>location ~* \.(png|ico|gif|jpg|jpeg)$ {
# совпадает с любым запросом заканчивающимся на png, ico, gif, jpgили jpeg. Однако, все
# запросы /img/ будут обработаны в предыдущем location, который мы указали в примере #4

# пример #5
}
</pre>
<p></p>
<h4>Реальные примеры директив location:</h4>

Использование директивы Location для Anti-hotlinking*:
<pre>location ~ \.(gif|png|jpe?g)$ {
valid_referers none blocked mywebsite.com *.mywebsite.com;
if ($invalid_referer) {
return   403;
}
}
</pre>
Другой пример, в котором запрещается доступ к выполнению скриптов из записываемых каталогов
<pre>location ~* /(images|cache|media|logs|tmp)/.*.(php|pl|py|jsp|asp|sh|cgi)$ {
return 403;
error_page 403 /403_error.html;
}</pre>
Использование Location чтобы включить autoindex** в nginx:
<pre>location /testing {
autoindex on;
autoindex_exact_size off;
autoindex_localtime on;
}</pre>
Если вы хотите больше узнать о директиве Location в nginx, можете прочитать <a href="http://nginx.org/en/docs/http/ngx_http_core_module.html#location" target="_blank">официальную документацию</a>.

* Anti-hotlinking– защита файлов вашего сайта от прямого доступа с других сайтов или сервисов.
** Autoindex — это функция, которая включает листинг директорий по http, средствами веб-сервера (конечно, если в директории нет настоящего index-файла).
