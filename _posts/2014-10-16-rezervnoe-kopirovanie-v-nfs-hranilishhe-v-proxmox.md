---
title: Резервное копирование в NFS хранилище в Proxmox
layout: post
permalink: /backup-on-nfs-in-proxmox/
redirect_from: /rezervnoe-kopirovanie-v-nfs-hranilishhe-v-proxmox/
excerpt: ""
tags:
  - CentOS
  - Iptables
  - NFS
  - Proxmox
---

{% include _toc.html %}

На работе решили использовать NFS сервер для резервных копий в Рroxmox. Думаю, стоит накидать заметку, чтобы не искать в следующий раз.

Чтобы nfs заработал в контейнере openvz, нужно чтобы в гипервизоре была поддержка nfs, т.е. установлен nfs-utils. В образе с Proxmox этот пакет установлен, если вы устанавливали гипервизор самостоятельно, то его, скорее всего, не будет.

{% highlight bash %}
Kernel NFS server
Kernel-space NFS server is supported by latest RHEL5 and RHEL6 based kernels and since vzctl-3.0.24.
NB! Currently only NFSv3 is supported — no NFSv4 support yet.
Prerequisites
In order to run an NFS server inside a container, make sure:
nfsd kernel module is loaded on host system before starting a container
nfsd feature for a container is turned on (vzctl set $CTID —feature nfsd:on —save)
{% endhighlight %}

### Установка nfs

{% highlight bash %}
$ yum install nfs-utils nfs-utils-lib
{% endhighlight %}

Запускаем демон rpcbind

{% highlight bash %}
$ chkconfig rpcbind on && service rpcbind start
{% endhighlight %}

Настраиваем nfs

{% highlight bash %}
$ vim /etc/sysconfig/nfs
{% endhighlight %}

Раскомментируем следующие строки

{% highlight bash %}
MOUNTD_NFS_V3="yes"
RPCNFSDARGS="-N 4"
NFSD_MODULE="noload"
{% endhighlight %}

Добавим следующие строки

{% highlight bash %}
LOCKD_TCPPORT=32803
LOCKD_UDPPORT=32769
MOUNTD_PORT=892
RQUOTAD_PORT=875
STATD_PORT=662
STATD_OUTGOING_PORT=2020
{% endhighlight %}

Стартуем сервис nfs

{% highlight bash %}
$ chkconfig nfs on
$ service nfs start
{% endhighlight %}

### Iptables

Генерируем файл правил

{% highlight bash %}
$ iptables-save
{% endhighlight %}

Правим файл в соответствии с

{% highlight bash %}
# Generated by iptables-save v1.4.7 on Mon Oct  6 02:58:25 2014
*filter
:INPUT DROP [6251:6489925]
-A INPUT -s 192.168.0.0/24 -m state --state NEW -p udp --dport 111 -j ACCEPT
-A INPUT -s 192.168.0.0/24 -m state --state NEW -p tcp --dport 111 -j ACCEPT
-A INPUT -s 192.168.0.0/24 -m state --state NEW -p tcp --dport 2049 -j ACCEPT
-A INPUT -s 192.168.0.0/24 -m state --state NEW -p tcp --dport 32803 -j ACCEPT
-A INPUT -s 192.168.0.0/24 -m state --state NEW -p udp --dport 32769 -j ACCEPT
-A INPUT -s 192.168.0.0/24 -m state --state NEW -p tcp --dport 892 -j ACCEPT
-A INPUT -s 192.168.0.0/24 -m state --state NEW -p udp --dport 892 -j ACCEPT
-A INPUT -s 192.168.0.0/24 -m state --state NEW -p tcp --dport 875 -j ACCEPT
-A INPUT -s 192.168.0.0/24 -m state --state NEW -p udp --dport 875 -j ACCEPT
-A INPUT -s 192.168.0.0/24 -m state --state NEW -p tcp --dport 662 -j ACCEPT
-A INPUT -s 192.168.0.0/24 -m state --state NEW -p udp --dport 662 -j ACCEPT
-A INPUT -m state --state NEW -p tcp --dport 22 -j ACCEPT
-A INPUT -i lo -j ACCEPT
-A INPUT -p icmp -m icmp --icmp-type 8 -j ACCEPT
-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [3092:284379]
COMMIT
# Completed on Mon Oct  6 02:58:25 2014
# Generated by iptables-save v1.4.7 on Mon Oct  6 02:58:25 2014
*mangle
:PREROUTING ACCEPT [6251:6489925]
:INPUT ACCEPT [6251:6489925]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [3092:284379]
:POSTROUTING ACCEPT [3092:284379]
COMMIT
# Completed on Mon Oct  6 02:58:25 2014
# Generated by iptables-save v1.4.7 on Mon Oct  6 02:58:25 2014
*nat
:PREROUTING ACCEPT [10:449]
:POSTROUTING ACCEPT [217:15513]
:OUTPUT ACCEPT [217:15513]
COMMIT
# Completed on Mon Oct  6 02:58:25 2014
{% endhighlight %}

Применяем новые правила

{% highlight bash %}
$ service iptables restart
{% endhighlight %}

Ссылки:

* Подробности читаем <a href="http://openvz.org/NFS_server_inside_container" target="_blank">здесь</a>
* Сам nfs я устанавливал по <a href="https://www.digitalocean.com/community/tutorials/how-to-set-up-an-nfs-mount-on-centos-6" target="_blank">этой инструкции</a>
* Не нашел изначальную статью по iptables по которой делал, но <a href="http://mcdee.com.au/tutorial-configure-iptables-for-nfs-server-on-centos-6/" target="_blank">эта тоже ничего </a>
